# 🚀 iFly 导航数据转换器使用指南

本指南将详细介绍如何使用 iFly 导航数据转换器，从基础操作到高级功能，帮助您顺利完成 Fenix 到 iFly 的导航数据转换。

## 🎯 使用前准备

### 1. 文件准备检查清单

在开始转换之前，请确认您已准备好以下文件：

- ✅ **Fenix 导航数据库** (`nd.db3`)
  ```
  位置: %APPDATA%\Microsoft Flight Simulator\Packages\fenix-a320\SimObjects\Airplanes\FenixA320\navdata\nd.db3
  大小: 通常为 50-200MB
  格式: SQLite 数据库文件
  ```

- ✅ **NAIP 航路数据** (`RTE_SEG.csv`)
  ```
  来源: 中国民航数据服务网站
  编码: UTF-8
  大小: 通常为 5-20MB
  格式: CSV 文件，包含航路段信息
  ```

- ✅ **iFly 737 MAX 8** 已安装并可正常运行

### 2. 环境验证

运行环境检查脚本：
```bash
# 验证 Python 环境
python --version  # 应显示 3.8 或更高版本

# 验证依赖包
python -c "import rich, pandas, pygeomag; print('环境验证通过!')"

# 检查可用内存
python -c "import psutil; print(f'可用内存: {psutil.virtual_memory().available // (1024**3)} GB')"
```

## 🖥️ 交互式使用

### 启动转换器

```bash
# 进入项目目录
cd /path/to/ifly-converter

# 启动转换器
python main.py
```

### 欢迎界面

转换器启动后，您将看到现代化的欢迎界面：

```
╔═══════════════════════════════════════ 🛩️  航空导航数据转换工具  ✈️ ═══════════════════════════════════════╗
║                                                                                                          ║
║                                      Fenix到iFly航空导航数据转换器                                       ║
║                                          高质量、现代化的转换体验                                         ║
║                                                                                                          ║
╚═══════════════════════════════════════ Powered by Rich • 版本 2.0 ═══════════════════════════════════════╝

🔍 系统检查...
✅ Python 环境: 3.9.16
✅ 依赖包: 全部已安装
✅ 可用内存: 8.2 GB
✅ 磁盘空间: 125 GB

准备开始转换过程...
```

## 📋 转换步骤详解

### 步骤 1: 连接 Fenix 数据库

```
╭─────────────────────────────────────────────── 🔄 步骤 1/4 ────────────────────────────────────────────────╮
│ 连接 Fenix 数据库                                                                                        │
│ 请选择 Fenix A320 导航数据库文件 (nd.db3)                                                                │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────╯

请输入 Fenix 数据库文件路径: 
```

**输入示例:**
```bash
# Windows 路径
C:\Users\Username\AppData\Roaming\Microsoft Flight Simulator\Packages\fenix-a320\SimObjects\Airplanes\FenixA320\navdata\nd.db3

# 或直接按 Enter 使用自动检测
[按 Enter 使用自动检测]
```

**验证过程:**
```
🔍 正在验证数据库...
✅ 文件存在且可读
✅ 数据库格式正确
✅ 必要表格完整 (11/11)
📊 数据统计:
   • 机场: 15,234 个
   • 跑道: 28,456 条
   • 航路点: 156,789 个
   • 终端程序: 8,945 个
```

### 步骤 2: 选择 CSV 文件

```
╭─────────────────────────────────────────────── 🔄 步骤 2/4 ────────────────────────────────────────────────╮
│ 选择 NAIP 航路数据                                                                                        │
│ 请选择中国民航 RTE_SEG.csv 文件                                                                           │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────╯

请输入 CSV 文件路径:
```

**验证过程:**
```
🔍 正在验证 CSV 文件...
✅ 文件编码: UTF-8
✅ 格式验证通过
✅ 必要列存在
📊 数据预览:
   • 总记录数: 12,456 条
   • 航路数量: 345 条
   • 覆盖区域: 中国大陆、香港、澳门
   • 数据时效: AIRAC 2508
```

### 步骤 3: 定位 iFly 安装

```
╭─────────────────────────────────────────────── 🔄 步骤 3/4 ────────────────────────────────────────────────╮
│ 定位 iFly 安装                                                                                            │
│ 正在搜索 iFly 737 MAX 8 安装位置...                                                                       │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────╯

🔍 扫描常见安装位置...
✅ 找到 iFly 安装: Community\ifly-aircraft-737max8\
📁 安装路径: C:\Users\Username\AppData\Local\Packages\Microsoft.FlightSimulator_xxx\LocalCache\Packages\Community\ifly-aircraft-737max8\
📋 目录结构验证:
   ✅ Data\navdata\Permanent\
   ✅ Data\navdata\Supplemental\
   ✅ 写入权限正常
```

如果自动检测失败，系统会提示手动输入：
```
❌ 自动检测失败
请手动输入 iFly 737 MAX 8 安装路径:
```

### 步骤 4: 配置转换选项

```
╭─────────────────────────────────────────────── 🔄 步骤 4/4 ────────────────────────────────────────────────╮
│ 配置转换选项                                                                                              │
│ 设置终端程序处理参数                                                                                      │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────╯

终端程序 ID 起始值 [默认: 1000]:
```

**配置选项说明:**
```
📊 终端程序 ID 配置:
   • 起始 ID: 1000 (推荐)
   • 预计使用范围: 1000-3500
   • 可用 ID 总数: 9000
   • 建议预留: 20% 缓冲区

⚙️ 其他选项:
   • 坐标精度: 8 位小数 (默认)
   • 磁偏角计算: WMM-2025 模型
   • AIRAC 周期: 自动计算
```

## 🔄 转换过程

### 配置确认

在开始转换前，系统会显示完整的配置摘要：

```
┌────────────────────────────────── ✅ 转换配置确认 ──────────────────────────────────┐
│                                                                                   │
│  📂 数据源配置                                                                     │
│  ├─ Fenix 数据库: .../navdata/nd.db3 (142.5 MB)                                  │
│  ├─ NAIP CSV 文件: .../RTE_SEG.csv (8.2 MB)                                      │
│  └─ iFly 安装路径: .../ifly-aircraft-737max8/                                    │
│                                                                                   │
│  ⚙️ 处理参数                                                                       │
│  ├─ 终端程序起始 ID: 1000                                                          │
│  ├─ 坐标精度: 8 位小数                                                             │
│  ├─ 磁偏角模型: WMM-2025                                                           │
│  └─ AIRAC 周期: 2508 (自动计算)                                                    │
│                                                                                   │
│  📊 预计处理                                                                       │
│  ├─ 航路点: ~12,456 个                                                            │
│  ├─ 终端程序: ~350 个                                                             │
│  └─ 预计时间: 5-10 分钟                                                           │
│                                                                                   │
└───────────────────────────────────────────────────────────────────────────────────┘

确认开始转换? [Y/n]:
```

### 航路数据处理

```
╭─────────────────────────────────────────── 🛣️ 处理航路数据 ───────────────────────────────────────────╮
│                                                                                                      │
│ 正在处理 NAIP 航路段数据...                                                                          │
│                                                                                                      │
│ ████████████████████████████████████████ 12,456/12,456 (100%) ⏱️ 0:03:45                         │
│                                                                                                      │
│ 当前处理: A1 航路 → ZSAM-VOR01 段                                                                   │
│ 磁偏角计算: 39.917°N, 116.383°E → +7.2°                                                            │
│                                                                                                      │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────╯

📊 航路处理统计:
✅ 成功处理: 12,456 个航路点
✅ 磁偏角计算: 12,456 次 (平均 0.02s/次)
✅ 输出文件: WPNAVRTE.txt (增加 2.3 MB)
⚠️ 跳过记录: 23 个 (坐标异常)
```

### 终端程序处理

```
╭─────────────────────────────────────────── 🏢 处理终端程序 ───────────────────────────────────────────╮
│                                                                                                      │
│ 正在转换终端程序数据...                                                                              │
│                                                                                                      │
│ ████████████████████████████████████████ 350/350 (100%) ⏱️ 0:02:15                               │
│                                                                                                      │
│ 当前处理: ZBAA (北京首都) → SID SHUAY1A                                                             │
│ 程序类型: 标准仪表离场程序                                                                           │
│                                                                                                      │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────╯

📊 终端程序统计:
✅ 处理机场: 145 个
✅ SID 程序: 234 个
✅ STAR 程序: 198 个  
✅ 进近程序: 312 个
✅ 新增文件: 89 个
✅ 更新文件: 56 个
```

### AIRAC 周期管理

```
╭─────────────────────────────────────────── 📅 AIRAC 周期管理 ──────────────────────────────────────────╮
│                                                                                                      │
│ 正在计算和设置 AIRAC 周期...                                                                         │
│                                                                                                      │
│ 🗓️ 计算信息                                                                                          │
│ ├─ 基准日期: 2024-01-11 (AIRAC 2401)                                                               │
│ ├─ 当前日期: 2024-12-24                                                                             │
│ ├─ 经过天数: 348 天                                                                                  │
│ ├─ 经过周期: 12.43 → 12 个完整周期                                                                   │
│ └─ 当前周期: 2508                                                                                    │
│                                                                                                      │
│ 📋 周期详情                                                                                          │
│ ├─ AIRAC 标识: 2508                                                                                 │
│ ├─ 生效日期: 2024-12-19                                                                             │
│ ├─ 失效日期: 2025-01-16                                                                             │
│ └─ 剩余天数: 23 天                                                                                   │
│                                                                                                      │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────╯

✅ AIRAC 文件已生成: FMC_Ident.txt
```

## ✅ 转换完成

### 成功摘要

```
┌─────────────────────────────────────────── ✅ 转换完成 ───────────────────────────────────────────────┐
│                                                                                                        │
│  🎉 恭喜！导航数据转换成功完成                                                                          │
│                                                                                                        │
│  📊 处理统计                                                                                            │
│  ├─ 🛣️ 航路数据: 12,456 个航路点                                                                       │
│  ├─ 🏢 终端程序: 350 个程序 (145 个机场)                                                               │
│  ├─ 📅 AIRAC 周期: 2508                                                                               │
│  └─ ⏱️ 总耗时: 6 分 32 秒                                                                             │
│                                                                                                        │
│  📁 输出文件                                                                                            │
│  ├─ WPNAVRTE.txt: 航路数据 (+2.3 MB)                                                                  │
│  ├─ FMC_Ident.txt: AIRAC 标识文件                                                                     │
│  ├─ Supplemental: 89 个新程序文件                                                                      │
│  └─ 转换日志: converter.log                                                                           │
│                                                                                                        │
│  🔄 下一步建议                                                                                          │
│  1. 重启 Microsoft Flight Simulator                                                                   │
│  2. 加载 iFly 737 MAX 8                                                                               │
│  3. 在 FMC 中验证新的航路和程序                                                                        │
│  4. 保存备份文件以便恢复                                                                               │
│                                                                                                        │
└────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 文件位置说明

转换完成后，文件将被放置在以下位置：

```
📁 iFly 导航数据目录:
Community\ifly-aircraft-737max8\Data\navdata\

├── Permanent\
│   ├── WPNAVRTE.txt        # 航路数据 (已更新)
│   └── 其他原始文件...
│
├── Supplemental\
│   ├── ZBAA\              # 北京首都机场
│   │   ├── SID\           # 标准仪表离场
│   │   ├── STAR\          # 标准终端到达
│   │   └── APP\           # 进近程序
│   ├── ZSPD\              # 上海浦东机场
│   └── ...其他机场
│
└── FMC_Ident.txt          # AIRAC 标识文件
```

## 🧪 验证转换结果

### 1. 文件验证

```bash
# 检查文件是否生成
ls -la "Community\ifly-aircraft-737max8\Data\navdata\"

# 检查文件大小 (应该比转换前大)
du -h "Community\ifly-aircraft-737max8\Data\navdata\Permanent\WPNAVRTE.txt"

# 验证 AIRAC 标识
cat "Community\ifly-aircraft-737max8\Data\navdata\FMC_Ident.txt"
```

### 2. 模拟器验证

1. **重启 MSFS**：完全退出并重新启动模拟器
2. **加载 iFly 737**：选择 iFly 737 MAX 8
3. **检查 FMC**：
   ```
   FMC 主页 → INIT REF → 查看 AIRAC 周期
   应显示: AIRAC 2508
   ```
4. **测试航路**：
   ```
   ROUTE 页面 → 输入中国航路 (如 A1, B1)
   应能正确显示航路点和距离
   ```

### 3. 功能测试清单

- [ ] **AIRAC 周期显示正确**
- [ ] **中国航路可以加载** (A1, B1, G212 等)
- [ ] **机场程序完整** (SID, STAR, APP)
- [ ] **航路点坐标准确**
- [ ] **磁偏角计算正确**
- [ ] **FMC 导航正常**

## 🔧 高级用法

### 批量处理模式

虽然当前版本不直接支持批量处理，但您可以通过脚本实现：

```python
# batch_convert.py
import subprocess
import os

databases = [
    "path/to/fenix_db1.db3",
    "path/to/fenix_db2.db3"
]

csv_file = "path/to/RTE_SEG.csv"

for db in databases:
    print(f"处理数据库: {db}")
    # 这里需要修改 main.py 以支持命令行参数
    # subprocess.run(["python", "main.py", "--db", db, "--csv", csv_file])
```

### 自定义配置文件

创建 `config.json` 文件来保存常用配置：

```json
{
    "default_fenix_path": "C:\\Users\\Username\\AppData\\Roaming\\Microsoft Flight Simulator\\Packages\\fenix-a320\\SimObjects\\Airplanes\\FenixA320\\navdata\\nd.db3",
    "default_csv_path": "D:\\Nav-Data\\RTE_SEG.csv",
    "terminal_id_start": 1500,
    "coordinate_precision": 8,
    "enable_backup": true,
    "backup_directory": "D:\\Nav-Data\\Backups"
}
```

### 数据更新流程

建议的定期更新流程：

```bash
# 1. 备份当前数据
cp -r "Community\ifly-aircraft-737max8\Data\navdata" "backup_$(date +%Y%m%d)"

# 2. 下载最新 NAIP 数据
# (从官方网站下载新的 RTE_SEG.csv)

# 3. 获取最新 Fenix 数据库
# (确保 Fenix A320 已更新到最新版本)

# 4. 运行转换器
python main.py

# 5. 验证结果
# (在模拟器中测试新数据)
```

## ⚠️ 注意事项

### 重要提醒

1. **数据备份**：转换前务必备份原始 iFly 导航数据
2. **版本兼容**：确保使用最新版本的 Fenix A320 和 iFly 737 MAX 8
3. **时效性**：建议每 28 天更新一次 AIRAC 数据
4. **验证测试**：转换后在关键航路上进行测试飞行

### 性能优化

1. **使用 SSD**：将数据文件放在 SSD 上以提高处理速度
2. **关闭杀毒**：临时关闭实时扫描以避免文件访问冲突
3. **充足内存**：确保至少有 4GB 可用内存
4. **稳定电源**：使用 UPS 或确保电源稳定

### 故障处理

如果转换过程中遇到问题：

1. **查看日志**：检查 `converter.log` 文件的错误信息
2. **重试操作**：某些网络或文件访问问题可能是临时的
3. **清理缓存**：删除临时文件后重新尝试
4. **降级设置**：如果内存不足，可以降低批处理大小

---

**恭喜您完成学习！** 🎉 

现在您已经掌握了 iFly 导航数据转换器的完整使用方法。如果遇到问题，请查看 [故障排除指南](../troubleshooting.md) 或 [常见问题](../faq.md)。

祝您飞行愉快！✈️
